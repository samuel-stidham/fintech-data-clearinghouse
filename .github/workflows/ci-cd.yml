name: CI/CD Pipeline

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v6

      - name: Set up Python
        uses: actions/setup-python@v6.2.0
        with:
          python-version: '3.14'

      - name: Install Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Run Tests
        run: |
          python -m pytest -v

  deploy:
    needs: test
    if: github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v6

      - name: Deploy to EC2
        env:
          PRIVATE_KEY: ${{ secrets.EC2_SSH_KEY }}
          HOST: ${{ secrets.EC2_HOST }}
          USER: ubuntu
        run: |
          mkdir -p ~/.ssh
          echo "$PRIVATE_KEY" > ~/.ssh/deployer_key
          chmod 600 ~/.ssh/deployer_key
          ssh-keyscan -H $HOST >> ~/.ssh/known_hosts

          rsync -avz --delete \
            --exclude '.git' \
            --exclude 'venv' \
            --exclude '__pycache__' \
            --exclude 'tests/__pycache__' \
            --exclude '.github' \
            -e "ssh -i ~/.ssh/deployer_key" \
            ./ $USER@$HOST:/home/$USER/app

          ssh -i ~/.ssh/deployer_key $USER@$HOST << EOF
            cd /home/$USER/app
            sudo docker-compose up -d --build --remove-orphans
            sudo docker image prune -f
          EOF

      - name: Verify Deployment (Smoke Test)
        env:
          HOST: ${{ secrets.EC2_HOST }}
        run: |
          echo "Waiting for service to stabilize..."
          URL="http://$HOST:5000/health"
          MAX_ATTEMPTS=5
          ATTEMPT=1
          
          sleep 10

          while [ $ATTEMPT -le $MAX_ATTEMPTS ]; do
            echo "Attempt $ATTEMPT: Pinging $URL..."
            
            HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" --max-time 5 $URL || echo "000")

            if [ "$HTTP_CODE" == "200" ]; then
              echo "âœ… Smoke Test Passed! Service is healthy."
              exit 0
            fi

            WAIT_TIME=$(( ATTEMPT * 5 ))
            echo "âš ï¸  Check failed (Status: $HTTP_CODE). Retrying in $WAIT_TIME seconds..."
            
            sleep $WAIT_TIME
            ATTEMPT=$(( ATTEMPT + 1 ))
          done

          echo "ðŸ’€ Smoke Test Failed: Service did not respond with 200 OK after $MAX_ATTEMPTS attempts."
          exit 1
